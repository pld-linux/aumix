--- aumix-2.1/doc/aumix.1	Mon Jan 31 23:30:12 2000
+++ aumix-2.1.pius/doc/aumix.1	Tue Feb  8 02:09:41 2000
@@ -115,15 +115,19 @@
 go into interactive mode after doing things non-interactively.
 .It Fl L
 load settings from
-.Pa $HOME/.aumixrc ,
-or
+.Pa $CONFIG_DIR/aumixrc ,
+.Pa $HOME/.aumixrc
+(depreciated), or
 .Pa /etc/aumixrc
 if the former is inaccessible
 .It Fl q
 query all devices and print their settings
 .It Fl S
 save settings to
+.Pa $CONFIG_DIR/aumixrc
+or
 .Pa $HOME/.aumixrc
+(depreciated)
 .El
 .Sh EXAMPLE
 The command
@@ -179,7 +183,10 @@
 show a description of the functions of keys
 .It L or l
 load settings from
-.Pa $HOME/.aumixrc ,
+.Pa $CONFIG_DIR/aumixrc ,
+or
+.Pa $HOME/.aumixrc
+(depreciated),
 falling back to
 .Pa /etc/aumixrc
 .It M or m
@@ -247,8 +254,11 @@
 Saved settings for the mixer are kept in the
 .Pa /etc/aumixrc
 and
-.Pa $HOME/.aumixrc
-files, but can be kept anywhere if specified explicitly.
+.Pa $CONFIG_DIR/aumixrc
+files, (
+.Pa $HOME/.aumixrc 
+is now obsolete, though it still works), 
+but can be kept anywhere if specified explicitly.
 Color schemes are normally kept in the directory given
 by
 .Ev DATADIRNAME
--- aumix-2.1/po/aumix.pot	Mon Jan 31 23:30:12 2000
+++ aumix-2.1.pius/po/aumix.pot	Tue Feb  8 02:09:41 2000
@@ -175,7 +175,7 @@
 "other options:\n"
 "  d:  adjust a device besides /dev/mixer\n"
 "  f:  specify file for saving and loading settings (defaults to\n"
-"      ~ /.aumixrc or /etc/aumixrc)\n"
+"      $CONFIG_DIR/aumixrc, ~ /.aumixrc or /etc/aumixrc)\n"
 "  C:  specify color scheme\n"
 "  h:  this helpful message\n"
 msgstr ""
--- aumix-2.1/po/de.po	Sun Nov 28 07:35:18 1999
+++ aumix-2.1.pius/po/de.po	Tue Feb  8 02:09:41 2000
@@ -81,7 +81,7 @@
 "other options:\n"
 "  d:  adjust a device besides /dev/mixer\n"
 "  f:  specify file for saving and loading settings (defaults to\n"
-"      ~ /.aumixrc or /etc/aumixrc)\n"
+"      $CONFIG_DIR/aumixrc, ~ /.aumixrc or /etc/aumixrc)\n"
 "  C:  specify color scheme\n"
 "  h:  this helpful message\n"
 msgstr ""
@@ -99,7 +99,7 @@
 "Weitere Optionen:\n"
 "  d:  Anderes Ger‰t als /dev/mixer benutzen\n"
 "  f:  spezifizieren Sie Datei f¸r Einsparung- und Ladeneinstellungen\n"
-"      (R¸ckstellungen zum ~ /.aumixrc or /etc/aumixrc)\n"
+"      (R¸ckstellungen zum $CONFIG_DIR/aumixrc, ~ /.aumixrc or /etc/aumixrc)\n"
 "  h:  Diese n¸tzlichen Informationen\n"
 
 #: src/common.c:567
--- aumix-2.1/po/es.po	Mon Dec  6 16:41:47 1999
+++ aumix-2.1.pius/po/es.po	Tue Feb  8 02:09:41 2000
@@ -81,7 +81,7 @@
 "other options:\n"
 "  d:  adjust a device besides /dev/mixer\n"
 "  f:  specify file for saving and loading settings (defaults to\n"
-"      ~ /.aumixrc or /etc/aumixrc)\n"
+"      $CONFIG_DIR/aumixrc, ~ /.aumixrc or /etc/aumixrc)\n"
 "  C:  specify color scheme\n"
 "  h:  this helpful message\n"
 msgstr ""
@@ -99,7 +99,7 @@
 "Otras opciones:\n"
 "  d:  ajustar dispositivos adem·s de /dev/mixer\n"
 "  f:  indicar el fichero para guardar y cargar las preferencias (por\n"
-"      defecto es ~/.aumixrc o /etc/aumixrc\n"
+"      defecto es $CONFIG_DIR/aumixrc, ~/.aumixrc o /etc/aumixrc\n"
 "  C:  indicar el esquema de color\n"
 "  h:  este mensaje de ayuda\n"
 
--- aumix-2.1/po/gl.po	Mon Dec  6 16:41:47 1999
+++ aumix-2.1.pius/po/gl.po	Tue Feb  8 02:09:41 2000
@@ -89,7 +89,7 @@
 "other options:\n"
 "  d:  adjust a device besides /dev/mixer\n"
 "  f:  specify file for saving and loading settings (defaults to\n"
-"      ~ /.aumixrc or /etc/aumixrc)\n"
+"      $CONFIG_DIR/aumixrc, ~ /.aumixrc or /etc/aumixrc)\n"
 "  C:  specify color scheme\n"
 "  h:  this helpful message\n"
 msgstr ""
@@ -107,7 +107,7 @@
 "outras opciÛns:\n"
 "  d:  axustar outro dispositivo que non sexa /dev/mixer\n"
 "  f:  especificar ficheiro para gardar e cargar par·metros (por omisiÛn È\n"
-"      ~/.aumixrc ou /etc/aumixrc)\n"
+"      $CONFIG_DIR/aumixrc, ~/.aumixrc ou /etc/aumixrc)\n"
 "  C:  especifica-lo esquema de cor\n"
 "  h:  amosar esta mensaxe de axuda\n"
 
--- aumix-2.1/po/pl.po	Tue Feb  8 02:15:54 2000
+++ aumix-2.1.pius/po/pl.po	Tue Feb  8 02:09:41 2000
@@ -181,7 +181,7 @@
 "other options:\n"
 "  d:  adjust a device besides /dev/mixer\n"
 "  f:  specify file for saving and loading settings (defaults to\n"
-"      ~/.aumixrc or /etc/aumixrc)\n"
+"      $CONFIG_DIR/aumixrc, ~/.aumixrc or /etc/aumixrc)\n"
 "  C:  specify color scheme\n"
 "  h:  this helpful message\n"
 msgstr ""
@@ -199,7 +199,7 @@
 "inne opcje:\n"
 "  d:  dostosowuje urz±dzenie inne niø /dev/mixer\n"
 "  f:  okre∂la plik do zapisywania i ≥adowania ustawieÒ (domy∂lnie jest to\n"
-"      ~/.aumixrc lub /etc/aumixrc)\n"
+"      $CONFIG_DIR/aumixrc, ~/.aumixrc lub /etc/aumixrc)\n"
 "  C:  okre∂la plik zawieraj±cy schemat uøycia kolorÛw\n"
 "  h:  ta pomocna informacja\n"
 
--- aumix-2.1/po/pt_BR.po	Sun Nov 28 07:35:18 1999
+++ aumix-2.1.pius/po/pt_BR.po	Tue Feb  8 02:09:41 2000
@@ -84,7 +84,7 @@
 "other options:\n"
 "  d:  adjust a device besides /dev/mixer\n"
 "  f:  specify file for saving and loading settings (defaults to\n"
-"      ~ /.aumixrc or /etc/aumixrc)\n"
+"      $CONFIG_DIR/aumixrc, ~ /.aumixrc or /etc/aumixrc)\n"
 "  C:  specify color scheme\n"
 "  h:  this helpful message\n"
 msgstr ""
@@ -102,7 +102,7 @@
 "outras opÁıes:\n"
 "  d:  usar outro dispositivo que n„o o /dev/mixer\n"
 "  f:  SPECIFY FILE FOR SAVING AND LOADING SETTINGS (DEFAULTS TO\n"
-"      ~ /.aumixrc or /etc/aumixrc)\n"
+"      $CONFIG_DIR/aumixrc, ~ /.aumixrc or /etc/aumixrc)\n"
 "  C:  SPECIFY COLOR SCHEME\n"
 "  h:  esta mensagem de ajuda\n"
 
--- aumix-2.1/po/ru.po	Mon Dec 20 02:13:11 1999
+++ aumix-2.1.pius/po/ru.po	Tue Feb  8 02:09:41 2000
@@ -188,7 +188,7 @@
 "other options:\n"
 "  d:  adjust a device besides /dev/mixer\n"
 "  f:  specify file for saving and loading settings (defaults to\n"
-"      ~ /.aumixrc or /etc/aumixrc)\n"
+"      $CONFIG_DIR/aumixrc, ~ /.aumixrc or /etc/aumixrc)\n"
 "  C:  specify color scheme\n"
 "  h:  this helpful message\n"
 msgstr ""
@@ -207,7 +207,7 @@
 "‰“’«…≈ œ–√……:\n"
 "  d:  “≈«’Ã…“œ◊¡‘ÿ ’”‘“œ ”‘◊¡ À“œÕ≈ /dev/mixer\n"
 "  f:  ’À¡⁄¡Œ…≈ …Õ≈Œ… ∆¡ Ã¡ ƒÃ— »“¡Œ≈Œ…— ’”‘¡Œœ◊œÀ (–œ ’ÕœÃﬁ¡Œ…¿\n"
-"      ~ /.aumixrc …Ã… /etc/aumixrc)\n"
+"      $CONFIG_DIR/aumixrc, ~ /.aumixrc …Ã… /etc/aumixrc)\n"
 "  C:  ◊Ÿ¬œ“ √◊≈‘œ◊œ  ”»≈ÕŸ\n"
 "  h:  ‹‘¡ –œÕœ›ÿ\n"
 
--- aumix-2.1/po/uk.po	Sun Nov 28 07:35:18 1999
+++ aumix-2.1.pius/po/uk.po	Tue Feb  8 02:09:41 2000
@@ -82,7 +82,7 @@
 "other options:\n"
 "  d:  adjust a device besides /dev/mixer\n"
 "  f:  specify file for saving and loading settings (defaults to\n"
-"      ~ /.aumixrc or /etc/aumixrc)\n"
+"      $CONFIG_DIR/aumixrc, ~ /.aumixrc or /etc/aumixrc)\n"
 "  C:  specify color scheme\n"
 "  h:  this helpful message\n"
 msgstr ""
@@ -101,7 +101,7 @@
 "∂Œ€¶ œ–√¶ß:\n"
 "  d:  “≈«’Ã¿◊¡‘… –“…”‘“œß œÀ“¶Õ /dev/mixer\n"
 "  f:  ◊À¡⁄¡ŒŒ— ¶Õ≈Œ¶ ∆¡ Ã’ ƒÃ— ⁄¬≈“¶«¡ŒŒ— “¶◊Œ¶◊ (⁄¡ ⁄¡Õœ◊ﬁ¡ŒŒ—Õ\n"
-"      ~ /.aumixrc ﬁ… /etc/aumixrc)\n"
+"      $CONFIG_DIR/aumixrc, ~ /.aumixrc ﬁ… /etc/aumixrc)\n"
 "  C:  SPECIFY COLOR SCHEME\n"
 "  h:  √— ƒœ–œÕœ«¡\n"
 
--- aumix-2.1/src/Makefile.am	Sat Dec 25 17:53:54 1999
+++ aumix-2.1.pius/src/Makefile.am	Tue Feb  8 02:09:41 2000
@@ -1,8 +1,8 @@
 bin_PROGRAMS	= aumix
 bin_SCRIPTS	= xaumix
-aumix_SOURCES	= common.c curses.c dummy.c gpm-xterm.c gtk.c interactive.c \
-		mouse.c common.h curses.h gpm-xterm.h gtk.h interactive.h  \
-		mouse.h
+aumix_SOURCES	= userdir.c common.c curses.c dummy.c gpm-xterm.c gtk.c \
+		interactive.c mouse.c userdir.h common.h curses.h gpm-xterm.h \
+		gtk.h interactive.h mouse.h
 localedir	= $(datadir)/locale
 INCLUDES	= -I../intl -DLOCALEDIR=\"$(localedir)\" -I@includedir@
 CFLAGS		= @CFLAGS@ @GLIB_CFLAGS@ @GTK_CFLAGS@
--- aumix-2.1/src/Makefile.in	Mon Jan 31 23:19:53 2000
+++ aumix-2.1.pius/src/Makefile.in	Tue Feb  8 02:09:41 2000
@@ -84,7 +84,7 @@
 
 bin_PROGRAMS = aumix
 bin_SCRIPTS = xaumix
-aumix_SOURCES = common.c curses.c dummy.c gpm-xterm.c gtk.c interactive.c 		mouse.c common.h curses.h gpm-xterm.h gtk.h interactive.h  		mouse.h
+aumix_SOURCES = userdir.c common.c curses.c dummy.c gpm-xterm.c gtk.c interactive.c 		mouse.c userdir.h common.h curses.h gpm-xterm.h gtk.h interactive.h  		mouse.h
 
 localedir = $(datadir)/locale
 INCLUDES = -I../intl -DLOCALEDIR=\"$(localedir)\" -I@includedir@
@@ -99,7 +99,7 @@
 
 CPPFLAGS = @CPPFLAGS@
 LDFLAGS = @LDFLAGS@
-aumix_OBJECTS =  common.o curses.o dummy.o gpm-xterm.o gtk.o \
+aumix_OBJECTS =  userdir.o common.o curses.o dummy.o gpm-xterm.o gtk.o \
 interactive.o mouse.o
 aumix_LDADD = $(LDADD)
 aumix_DEPENDENCIES = 
--- aumix-2.1/src/common.c	Mon Jan 31 23:30:12 2000
+++ aumix-2.1.pius/src/common.c	Tue Feb  8 02:14:43 2000
@@ -24,6 +24,7 @@
 #include "gtk.h"
 #endif
 #include "interactive.h"
+#include "userdir.h"
 
 void            ExitIfError(int error);
 int             InitializeMixer(char *device_file);
@@ -536,7 +537,8 @@
 {
 /* Open the settings file for reading or writing.
 
-   Try first ${HOME}/.AUMIXRC, then AUMIXRC_PATH/AUMIXRC;
+   Try first ${CONFIG_DIR}/AUMIXRC, then ${HOME}/.AUMIXRC
+   and eventually AUMIXRC_PATH/AUMIXRC;
    become an error generator if neither can be opened.
 
    Input:
@@ -551,19 +553,25 @@
 	FILE           *setfile;
 	char           *home;
 	char            filename[FILENAME_MAX];
+	struct cfv     etcfile;
+	
 	if (save_filename == NULL) {
-		home = getenv("HOME");
-		sprintf(filename, "%s/.%s", home, AUMIXRC);
-		setfile = fopen(filename, mode);
-		if (setfile == NULL) {
-			sprintf(filename, "%s/%s", AUMIXRC_PATH, AUMIXRC);
-			setfile = fopen(filename, mode);
-		}
-		if (setfile == NULL) {
-			return NULL;
-		}
+	    etcfile.variable = "CONFIG_DIR";
+	    etcfile.home_dir = NULL;
+	    etcfile.home_scd = NULL;
+	    etcfile.subname  = AUMIXRC;
+	    etcfile.prefix   = ".";
+	    etcfile.suffix   = "";
+	    etcfile.mode     = M_REGULAR_FILE;
+
+    	    setfile = fopencfv(&etcfile, mode);
+	    	    
+	    if (setfile == NULL) {
+		    sprintf(filename, "%s/%s", AUMIXRC_PATH, AUMIXRC);
+		    setfile = fopen(filename, mode);
+	        }
 	} else
-		setfile = fopen(save_filename, mode);
+	    setfile = fopen(save_filename, mode);
 	return setfile;
 }
 
@@ -649,7 +657,7 @@
 other options:\n\
   d:  adjust a device besides /dev/mixer\n\
   f:  specify file for saving and loading settings (defaults to\n\
-      ~ /.aumixrc or /etc/aumixrc)\n\
+      $CONFIG_DIR/aumixrc, ~/.aumixrc or /etc/aumixrc)\n\
   C:  specify color scheme\n\
   h:  this helpful message\n"));
 #ifdef HAVE_CURSES
--- aumix-2.1/src/userdir.c	Thu Jan  1 01:00:00 1970
+++ aumix-2.1.pius/src/userdir.c	Sat Feb  5 21:19:17 2000
@@ -0,0 +1,167 @@
+// $Id$
+#include "userdir.h"
+    
+static char *nonulhome = "";
+
+/******************************************************************************/
+    
+int getusercfv (char *variable, 
+		    char *home_dir, 
+		    char *user_dir, 
+		    size_t stringsize)
+{
+	struct stat st;
+	char *d;
+	
+	bzero (user_dir, stringsize);
+	if (variable == NULL || *variable == '\0') return (-1);
+	if (home_dir == NULL) home_dir = nonulhome;
+	d = getenv (variable);	
+	if (d == NULL || *d == '\0') return (-1);
+	if (*d == '/') 
+	    {
+	    strncpy (user_dir, d, stringsize-1);
+	    }
+	else
+	    {
+	    snprintf (user_dir, stringsize-1, "%s/%s", home_dir, d);
+	    }
+	    
+	if (stat(user_dir,&st) != -1 && S_ISDIR(st.st_mode)) 
+	    {
+	    return (0);
+	    }
+	
+	return (-1);
+}
+
+/******************************************************************************/
+
+int detectcfv(struct cfv *CFV) {
+	if (CFV->subname == NULL) CFV->subname = nonulhome;
+	if (CFV->home_dir == NULL) CFV->home_dir = getenv ("HOME");
+	if (CFV->home_dir == NULL) CFV->home_dir = CFV->home_scd;
+	if (CFV->home_dir == NULL) return (-1);
+	return 0;
+}
+
+/******************************************************************************/
+
+int preparemain(struct cfv *CFV) {
+	char *p;
+	struct stat st;
+	if ((p = strrchr(CFV->result, '/')) && *(p+1) == '\0') 
+	    p = '\0';
+	snprintf ((rindex(CFV->result,'\0')), MAXPATHLEN-1, "/%s", 
+		  CFV->subname);
+	if (stat( CFV->result,&st) != -1 
+	     && CFV->mode ? 
+		S_ISDIR(st.st_mode) : 
+		S_ISREG(st.st_mode)) /* have file or dir */
+	    return (1);
+	return 0;
+}
+
+/******************************************************************************/
+
+int preparehome(struct cfv *CFV) {
+	struct stat st;
+    	if (CFV->home_dir == NULL || *(CFV->home_dir) == '\0') return (-1);
+	if (CFV->prefix == NULL && CFV->suffix == NULL) return (-1);
+	snprintf (CFV->result, MAXPATHLEN-1, "%s/%s%s%s", 
+		       CFV->home_dir, 
+		       CFV->prefix? CFV->prefix:"",
+		       CFV->subname,
+		       CFV->suffix? CFV->suffix:"");
+	if (stat(CFV->result,&st) != -1 
+		 && CFV->mode ? 
+		    S_ISDIR(st.st_mode) : 
+		    S_ISREG(st.st_mode)) /* have file or dir */
+		return (2);
+	return (-1);
+}
+
+/******************************************************************************/
+
+int usercfv (struct cfv *CFV) {
+	int gr;
+	gr = detectcfv(CFV);
+	if (gr) return gr;
+	/* get environment variable */
+	gr = getusercfv (CFV->variable, 
+			CFV->home_dir, 
+			CFV->result,
+			MAXPATHLEN);
+	if (gr != -1) 	/* have main directory */
+	    {
+		gr = preparemain(CFV);
+		if (gr) return gr;
+	    }
+	/* don't have main directory or a proper variable set */
+	gr = preparehome(CFV);
+	return gr;
+}
+	
+/******************************************************************************/
+
+/* If directory or file doesn't exist returns the best one wich may be created */
+int notnullusercfv (struct cfv *CFV) {
+	int gr;
+	if ((usercfv(CFV)) == -1) {
+	    gr = detectcfv(CFV);
+	    if (gr) return gr;	/* remember, it works for errors! */
+	    /* get the environment variable */
+	    gr = getusercfv (CFV->variable, 
+			    CFV->home_dir, 
+			    CFV->result,
+			    MAXPATHLEN);
+	    if (gr != -1) 	/* have main directory */
+		{
+		    gr = preparemain(CFV);
+		    return 0;
+		}
+	    /* don't have main directory or a proper variable set */
+	    gr = preparehome(CFV);
+	    return 0;
+ 	}
+	return 0;	
+}
+    
+/******************************************************************************/
+
+FILE *maynullfopencfv (struct cfv *CFV, const char *mode)
+    {
+    FILE *cfvfile = NULL;
+    
+    CFV->mode = M_REGULAR_FILE;
+    if ((usercfv (CFV)) == -1) return (NULL);	
+    cfvfile = fopen (CFV->result, mode);
+    return (cfvfile);
+    }
+/******************************************************************************/
+
+FILE *notnullfopencfv (struct cfv *CFV, const char *mode)
+    {
+    FILE *cfvfile = NULL;
+    
+    CFV->mode = M_REGULAR_FILE;
+    if ((notnullusercfv (CFV)) == -1) return (NULL);	
+    cfvfile = fopen (CFV->result, mode);
+    return (cfvfile);
+    }
+
+/******************************************************************************/
+    
+FILE *fopencfv (struct cfv *CFV, const char *mode)
+    {
+    FILE *cfvfile = NULL;
+
+    if (cfvfile == NULL && (strpbrk(mode, "wa")) != NULL) /* create in best location */
+	cfvfile = notnullfopencfv (CFV, mode);
+    else 
+	cfvfile = maynullfopencfv (CFV, mode);
+    
+    return (cfvfile);
+    }
+
+/******************************************************************************/
\ No newline at end of file
--- aumix-2.1/src/userdir.h	Thu Jan  1 01:00:00 1970
+++ aumix-2.1.pius/src/userdir.h	Sat Feb  5 21:19:17 2000
@@ -0,0 +1,56 @@
+// $Id$
+#ifndef USERDIR__H
+#define USERDIR__H
+
+#include <unistd.h>
+#include <string.h>
+#include <stdio.h>
+#include <stdlib.h>
+#include <sys/types.h>
+#include <sys/stat.h>
+#include <sys/param.h>
+
+#define	M_REGULAR_FILE	0
+#define	M_DIRECTORY	1
+
+struct cfv {
+	char result[MAXPATHLEN];	/* our result			*/
+	char *variable;	/* name of an environment variable		*/
+	char *home_dir;	/* home directory or NULL for autodetect	*/
+	char *home_scd; /* directory if home_dir==NULL and no result	*/
+	char *subname;	/* core name of a file/directory		*/
+    	char *prefix;	/* prefix when using directly home_dir		*/
+	char *suffix;	/* suffix when using directly home_dir		*/
+	int mode;	/* expected: M_REGULAR_FILE or M_DIRECTORY	*/
+	};
+
+/* reads environment variable. if the path isn't absolute will add $HOME/
+ * at the beginning
+ * return: 0 - directory exists
+ *         -1 - directory doesn't exist
+ */
+int getusercfv (char *variable, 
+		    char *home_dir, 
+		    char *user_dir,
+		    size_t stringsize);
+/* reads the $HOME variable */
+int detectcfv(struct cfv *CFV);
+
+/* looks for the config/data file/dir.
+ * result: -1 - error - cannot find file/dir 
+ *         0 - ok
+ *         CFV.result set
+ */
+int usercfv (struct cfv *CFV);
+/* looks for the config/data file/dir.
+ * result: -1 - error - cannot read $HOME
+ *          0 - ok - if the CFV.result exists, read it. If not create it.
+ *              CFV.result set
+ */              
+int notnullusercfv (struct cfv *CFV);
+
+FILE *fopencfv (struct cfv *CFV, const char *mode);
+FILE *maynullfopencfv (struct cfv *CFV, const char *mode);
+FILE *notnullfopencfv (struct cfv *CFV, const char *mode);
+
+#endif
